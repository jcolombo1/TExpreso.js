// (c)2013 Jorge Colombo - jcolombo@ymail.com - t: @jcolombo_ - f: /Jorge Colombo

(function(window){'use strict';function TExpreso(){var self=this,VERSION='1.1',rexp={DBEG:'\\{\\{',DEND:'\\}\\}'},cache,MEM,rexpHlps;this.reset=function(){cache={tpl:{},hlp:{}};MEM={};rexpHlps={};self.addHelper('set',_h_set);self.addHelper('if',_h_if,false,/[%\$\w][\w\.\$]*|>|<|\=\=|!\=|>\=|<\=/g);self.overwrite=false;self.VERSION=VERSION;self.ME='TExpreso v.'+VERSION;};this.add=function(tname,str,overwrite,addInterceptor){if(cache.tpl[tname]&&!(overwrite||self.overwrite)){console.info('try overwrite template: '+tname);return false;};self.tname=tname;self.error='';var tpl=typeof addInterceptor==='function'?_parse(addInterceptor(tname,str)):_parse(str);if(tpl)cache.tpl[tname]=tpl;else if(cache.tpl[tname])cache.tpl[tname]=undefined;return tpl;};this.addHelper=function(name,fn,overwrite,rexpp){var rv;self.tname=name;self.error='';if(typeof fn!=='function')_error('Invalid helper add');else if(cache.hlp[name]&&!(overwrite||self.overwrite))console.info('try overwrite helper: '+name);else{cache.hlp[name]=fn;rv=true;if(rexpp)rexpHlps[name]=rexpp;};return rv;};this.render=function(tname,scope,retainMem){var tpl=cache.tpl[tname];self.tname=tname;self.error='';MEM=typeof retainMem=='object'?retainMem:!retainMem?MEM={}:MEM;if(tpl)return _rend(tpl.T,(scope?scope:{}));_error('Template '+tname+' not found');return'';};this.express=function(arg1,arg2,arg3){var sco=(arg3!==undefined?arg3:arg2),rv='',e;if(!/^[\w-:\.]+$/g.test(arg1))return _rend(_parse(arg1)['T'],sco);if(!cache.tpl[arg1])if((e=window.document.getElementById(arg1))){self.add(arg1,e.text);console.info('agrega '+arg1);};if((rv=self.render(arg1,sco)))if((e=window.document.getElementById(arg2)))e.innerHTML=rv;return rv;};this.get=function(tname){return cache.tpl[tname];};this.has=function(tname,ttype){return((ttype=='helper'?cache.hlp[tname]:cache.tpl[tname])?true:false);};this.names=function(ttype){var rv=[],obj=ttype=='helper'?cache.hlp:cache.tpl;for(var i in obj){rv.push(i);};return rv;};this.delimiter=function(s){if(s=='['||s==']'){rexp.DBEG='\\[\\[';rexp.DEND='\\]\\]';}else if(s=='('||s==')'){rexp.DBEG='\\(\\(';rexp.DEND='\\)\\)';}else{rexp.DBEG='\\{\\{';rexp.DEND='\\}\\}';};};function _rend(node,scope){if(!node)return'';var buf='';for(var i in node){if(typeof node[i]==='string')buf+=_rendStr(node[i],scope);else{var ok=false,fn,op=node[i].op;if((fn=cache.hlp[op[1]])){var t=function(sc){return _rend(node[i].T,_doScope(sc,scope));};var e=function(sc){return node[i].E?_rend(node[i].E,_doScope(sc,scope)):'';};buf+=fn(_helperPars(op,scope),{T:t,E:e,op:op,s:scope,get:_get,_error:_error,cache:cache});ok=true;}else{var x=op.length==2?_get(scope,op[1]):null,inv=op[0]=='^';if(((!!x||x===0)&&!inv)||((!x&&x!==0)&&inv)){if(x instanceof Array){if(x.length>0){for(var j in x){var row=x[j];row['%index']=parseInt(j);row['%row']=parseInt(j)+1;buf+=_rend(node[i].T,_doScope(row,scope));};ok=true;}}else{buf+=_rend(node[i].T,((x instanceof Object)?_doScope(x,scope):scope));ok=true;}}};if(!ok&&node[i].E){buf+=_rend(node[i].E,scope);}}};return buf;};function _rendStr(str,scope){var pp,bp,np=0;var buf='',m,pat=new RegExp(rexp.DBEG+'\\s*[^'+rexp.DEND+']+\\s*'+rexp.DEND,'gm');while((m=pat.exec(str))){pp=np;bp=m.index;np=m[0].length+m.index;buf+=str.substring(pp,bp);var op=_opMaker(str.substring(bp,np));if(op[0]==='>'){buf+=self.render(op[1],scope,true);}else{var fn,x=op.length==2?_get(scope,op[1]):null;if(x||x===0)buf+=x;else if((fn=cache.hlp[op[1]])){buf+=fn(_helperPars(op,scope),{op:op,s:scope,get:_get,_error:_error,cache:cache});}}};return buf+str.substring(np,str.length);};function _doScope(loc,parent){if(typeof parent==='object'&&loc!==parent)loc['..']=parent;return loc;};function _helperPars(op,scope){var pars=[],ps=[].concat(op);ps.shift();ps.shift();for(var i in ps){pars.push(_get(scope,ps[i])||'');};return pars;};function _parse(str){if(!str)return null;var node=_new(0),curr=node,m,x,deep=0,pp,bp,np=0,pat=new RegExp(rexp.DBEG+'\\s*(end|else|[#\\^].+?)\\s*'+rexp.DEND,'gm');function _xget(){return str.substring(pp,bp);};function _new(d,o){return{d:d,op:o,f:-1}};function _push(o,v){if(!v)return;var ix=o.f<0?'T':o.f<255?'I'+o.f:'E';if(o[ix]===undefined)o[ix]=[v];else o[ix].push(v);};curr.op=['prog'];while((m=pat.exec(str))){pp=np;bp=m.index;np=m[0].length+m.index;x=_new(null,_opMaker(str.substring(bp,np)));if(/\^|#/.test(x.op[0])){_push(curr,_xget());_push(curr,x);x.d=++deep;x.p=curr;curr=x;}else if(x.op[1]==='else'){if(!curr||curr===undefined||curr.d==0||curr.f>=255){_error('invalid spare "else" for: '+(curr&&curr.op[1]?curr.op[1]:'??'));return null;};_push(curr,_xget());curr.f=255;}else if(x.op[1]==='end'){_push(curr,_xget());curr=curr.p;deep--;if(!curr){_error('invalid spare "end"');return null;};};};pp=np;bp=str.length;_push(curr,_xget());if(!curr||curr.d>0){_error('missing any "end"');return null;};return node;};function _epat(s,pat){var c,arr=[];while((c=pat.exec(s))){arr.push(c[0].trim());};return arr;};function _opMaker(s){var rv,c,re=new RegExp(rexp.DBEG+'|'+rexp.DEND);var arr=_epat((s.split(re))[1],/"[^"]+?"|""|\s*[^"\s]+/g);var b=arr.shift();if((c=b.charAt(0))&&(c==='>'||c==='#'||c==='^')){rv=[c];if((c=b.slice(1)))rv.push(c);}else{rv=['',b];};for(var i in arr){if(!arr[i])continue;if(rv.length==2&&(c=rexpHlps[rv[1]]))rv=rv.concat(_epat(arr[i],c));else rv.push(arr[i]);};return rv;};function _get(o,p){var r,s,mem;try{if(p=='true')r=true;else if(/^["'].+["']$/.test(p))r=p.substring(1,p.length-1);else if(/^\d+\.?\d*$/.test(p))r=p;else if(/^[%\$\w][\w\.\$]*$/.test(p)){try{r=mem=p.charAt(0)=='$'?MEM:o,s=p.split('.');for(var i in s){r=r[s[i]];};}catch(x){r=undefined};if(r===undefined&&mem['..'])r=_get(mem['..'],p);};return r;}catch(x){};return;};function _error(m){self.error=m='[ template: '+self.tname+' ] '+m;console.error(m,' ');};function _h_set(par,options){var sfx=function(p,v){if(/^\$\w+$/.test(p))MEM[p]=v;else options._error('invalid var in "set": "'+p+'"');};if(typeof options.T=='function'){sfx((options.op[2]||''),options.T(options.s));}else{par.shift();sfx((options.op[2].replace('=','')||''),(par.join('')||''));};return'';};function _h_if(par,options){var rv='',v;if(typeof options.T=='function'){if(options.op.length==3)v=!!par[0];else{var op=options.op[3]||'';v=op=='=='?par[0]==par[2]:op=='!='?par[0]!=par[2]:op=='>'?par[0]>par[2]:op=='<'?par[0]<par[2]:op=='>='?par[0]>=par[2]:op=='<='?par[0]<=par[2]:_error('invalid "if": '+options.op.join(' '))||'';};rv=v?options.T(options.s):options.E(options.s);};return rv;};self.reset();};window.TExpreso=new TExpreso();}(window));