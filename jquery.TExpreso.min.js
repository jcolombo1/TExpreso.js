// (c)2014 Jorge Colombo - jcolombo@ymail.com - t: @jcolombo_ - f: /Jorge Colombo

(function($,window){'use strict';var VERSION='1.1',urls=[],ATTR_TPL_NAME='data-te-name',ATTR_TPL_TYPE='data-te-type',options={addInterceptor:null,templateType:'text/html',};function getTExpreso(){if(window.TExpreso==undefined){$.error("Failed to obtain TExpreso v1.x, you must load it!");return;};return window.TExpreso;};function has(tname,ttype){return getTExpreso().has(tname,ttype);};function hasUrl(tname){return urls.indexOf(tname)>=0};function getStatsInfo(){var af=function(x){x=x?x:'template';var ns=getTExpreso().names(x);return x+'s: '+(ns.length>0?ns.length+' ['+ns.join(', ')+']':'(no)');};return $.TExpreso.ME+' >> '+af()+', '+af('helper');};function addFromString(tname,thtml,ttype,overwrite){var rv;if(tname&&ttype&&thtml){if(ttype=='helper')rv=getTExpreso().addHelper(tname,eval(thtml),overwrite);else rv=getTExpreso().add(tname,thtml,overwrite,options.addInterceptor);};return!!rv?1:0;};function addFromUrl(url,doit,overwrite){if(!url||(!overwrite&&hasUrl(url))){if(doit)doit(0);return;};var cant=0;return $.ajax({url:url,dataType:'text',}).done(function(d){$(d.trim()).filter('script').each(function(i,el){var rv=false,id=$(el).attr(ATTR_TPL_NAME),ttype=$(el).attr(ATTR_TPL_TYPE);if(ttype=='helper')rv=getTExpreso().addHelper((id?id:el.id),eval($(el).html()),overwrite);else rv=getTExpreso().add((id?id:el.id),$(el).html(),overwrite,options.addInterceptor);if(rv)cant++;});}).always(function(){urls.push(url);if(doit)doit(cant,url);});};function addFromDom(id){var _normalize=function(e){if(e.tagName!=='SCRIPT'){var $scr=$('<script type="'+options.templateType+'">');$scr.html($(e).html());var dn=$(e).attr(ATTR_TPL_NAME),dt=$(e).attr(ATTR_TPL_TYPE),id=e.id;$(e).remove();$scr.attr('id',id);if(dn)$scr.attr(ATTR_TPL_NAME,dn);if(dt)$scr.attr(ATTR_TPL_TYPE,dt);$('body').append($scr);}};var cant=0,ids=id?[id]:$('script[type="'+options.templateType+'"]').map(function(){_normalize(this);return this.id;});$.each(ids,function(){var rv,el=document.getElementById(this);if(el===null)$.error('script id not found: #'+this);else{if($(el).attr(ATTR_TPL_TYPE)=='helper')rv=getTExpreso().addHelper(this,eval($(el).html()));else rv=getTExpreso().add(this,$(el).html(),false,options.addInterceptor);if(rv)cant++;}});return cant;};$.TExpreso={VERSION:VERSION,ME:'jQuery TExpreso v.'+VERSION+' ( '+getTExpreso().ME+' )',setAddInterceptor:function(fn){options.addInterceptor=fn;},addFromString:addFromString,addFromDom:addFromDom,addFromUrl:addFromUrl,getStatsInfo:getStatsInfo,getNames:getTExpreso().names,has:has,hasUrl:hasUrl,TExpreso:getTExpreso(),};$.fn.texpreso=function(tpl,data,retainMem){var inst=getTExpreso();return this.each(function(){$(this).html(inst.render(tpl,data||{},retainMem));});};$.fn.TExpreso=$.fn.texpreso;}(jQuery,window));